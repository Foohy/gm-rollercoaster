//NOTE WHEN ADDING NEW TRAINS
//if there are any uppercases in the filename, change them to be lowercase or else it will not work

ChairOffsets = {
	["models/xqm/coastertrain2seat.mdl"] = {
		Vector(8.8, 10.5, 19.4), -- front left
		Vector(8.8, -10.5, 19.4), -- front right
		Vector(-40.3, 10.5, 19.4), -- back left
		Vector(-40.3, -10.5, 19.4) -- back right
	},
	["models/props_c17/playground_carousel01.mdl"] = {
		Vector(0, 53, 20.2), //Angle( 0, 90, 0 )
		Vector(53, 0, 20.2), //Angle( 0, 0, 0 )
		Vector(0, -53, 20.2), //Angle( 0, -90, 0 )
		Vector(-53, 0, 20.2), //Angle( 0, 180, 0 )

		Vector(43, 43, 20.2), //Angle( 0, 45, 0 )
		Vector(43, -43, 20.2), //Angle( 0, -45, 0 )
		Vector(-43, 43, 20.2), //Angle( 0, 140, 0 )
		Vector(-43, -43, 20.2), //Angle( 0, -140, 0 )
	},
	["models/xqm/coastertrack/train_2.mdl"] = {
		Vector(30.7, -14, 20.8), 
		Vector(-30.7, -14, 20.2), 
	},
	["models/xqm/coastertrain1.mdl"] = {
		Vector( -60, 11, 23 ), 
		Vector( -9.6, 11, 23 ),  
		Vector( 40, 11, 23 ), 

		Vector( -60, -11, 23 ), 
		Vector( -9.6, -11, 23 ),
		Vector( 40, -11, 23 ), 
	},
	["models/xqm/coastertrain1seat.mdl"] = {
		Vector(-12.3, 11, 20.2),
		Vector(-12.3, -9.6, 20.2),
	},
	["models/sunabouzu/sonic_the_carthog.mdl"] = {
		Vector(15.8, -43, 14), -- front left
		Vector(-8.4, -43, 14), -- front right
		Vector(15.8, -3.5, 14), -- back left
		Vector(-8.4, -3.5, 14) -- back right
	},
	["models/props/de_inferno/furniture_couch02a.mdl"] = {
		Vector(7.6080, 0.2916, -5.1108)
	},
	["models/fishy/furniture/piano_seat.mdl"] = {
		Vector(2.7427, 13.2392, 22)
	},

	["models/gmod_tower/css_couch.mdl"] = {
		Vector(12.83425617218, -25.016822814941, 19.691375732422),
		Vector(11.887982368469, 0.47359153628349, 19.074829101563),
		Vector(11.508950233459, 26.898155212402, 18.528305053711),
	},
	["models/props/cs_office/sofa.mdl"] = {
		Vector(12.83425617218, -25.016822814941, 19.691375732422),
		Vector(11.887982368469, 0.47359153628349, 19.074829101563),
		Vector(11.508950233459, 26.898155212402, 18.528305053711),
	},
	["models/props/cs_office/sofa_chair.mdl"] = {
		Vector(7.77490234375, -0.62280207872391, 20.302822113037),
	},
	["models/props/de_tides/patio_chair2.mdl"] = {
		Vector(1.4963380098343, -1.5668944120407, 17.591537475586),
	},
	["models/gmod_tower/plazabooth.mdl"] = {
		Vector(26.779298782349, -48.443725585938, 17.575805664063),
		Vector(24.627443313599, -22.173582077026, 17.693496704102),
		Vector(24.728271484375, 4.1212167739868, 17.712997436523),
		Vector(24.429685592651, 29.835939407349, 17.069671630859),
		Vector(25.442136764526, 53.892211914063, 18.112731933594),
	},
	["models/props_trainstation/traincar_seats001.mdl"] = {
		Vector(4.6150, 41.7277, 18.5313),
		Vector(4.7320, 14.4948, 18.5313),
		Vector(4.5561, -13.3913, 18.5313),
		Vector(5.4507, -40.9903, 18.5313)
	},
	["models/props_c17/chair02a.mdl"] = {
		Vector(16.809963226318, 5.6439781188965, 1.887882232666),
	},
	["models/props_c17/chair_stool01a.mdl"] = {
		Vector(-0.4295127093792, -1.5806334018707, 35.876251220703),
	},
	["models/props/cs_militia/barstool01.mdl"] = {
		Vector(-0.72143560647964, 0.90307611227036, 33.387348175049),
	},
	["models/props_interiors/furniture_chair01a.mdl"] = {
		Vector(0.46997031569481, -0.053411800414324, -1.7953878641129),
	},
	["models/props_interiors/furniture_couch01a.mdl"] = {
		Vector(1.8,0,-6.5),
		Vector(1.8,-23.9,-6.5),
		Vector(1.8,23.9,-6.5),
	},
	["models/props_interiors/furniture_couch02a.mdl"] = {
		Vector(2.1,0,-6.3),
	},
	["models/props/cs_militia/couch.mdl"] = {
		Vector(30.384033203125, 5.251708984375, 15.507431030273),
		Vector(0.44091796875, 4.386474609375, 16.095657348633),
		Vector(-31.472412109375, 6.045166015625, 16.215229034424),
	},
	["models/props_c17/furnituretoilet001a.mdl"] = {
		Vector(0.90478515625, -0.208984375, -30.683263778687),
	},
	["models/props/cs_office/chair_office.mdl"] = {
		Vector(2.5078778266907, 1.4323912858963, 14.806640625),
	},
	["models/gmod_tower/stealth box/box.mdl"] = {
		Vector(-2.0869002342224, -10.265548706055, 37.816131591797),
	},
	["models/props_c17/furniturechair001a.mdl"] = {
		Vector(0.30538135766983, 0.14535087347031, -6.69970703125),
	},
	["models/gmod_tower/suitecouch.mdl"] = {
		Vector(2.5263111591339, -25.540681838989, 17.753444671631),
		Vector(2.563271522522, 0.83294534683228, 17.750255584717),
		Vector(1.3705009222031, 27.729253768921, 17.448686599731),
	},
	["models/props_combine/breenchair.mdl"] = {
		Vector(6.8169813156128, -2.8282260894775, 16.551658630371),
	},
	["models/gmod_tower/medchair.mdl"] = {
		Vector(6.8169813156128, 0.14535087347031, 16.551658630371),
	},
	["models/gmod_tower/comfychair.mdl"] = {
		Vector(7.77490234375, -0.62280207872391, 20.302822113037),
	},
	["models/sunabouzu/lobby_chair.mdl"] = {
		Vector(5.2, 0, 34.1),
	}
}
	
NotRight = {	
		["models/props/de_tides/patio_chair2.mdl"]	= 180,
	 	["models/props/cs_militia/couch.mdl"]		= 0,
		["models/gmod_tower/stealth box/box.mdl"]	= 180,
		["models/sunabouzu/sonic_the_carthog.mdl"] 	= 90,
}

local function HandleRollercoasterAnimation( vehicle, ply)
	return ply:SelectWeightedSequence( ACT_GMOD_SIT_ROLLERCOASTER ) 
end

function CreateSeatAtPos(pos, angle)
	local ent = ents.Create("prop_vehicle_prisoner_pod")
	ent:SetModel("models/nova/airboat_seat.mdl")
	ent:SetKeyValue("vehiclescript","scripts/vehicles/prisoner_pod.txt")
	ent:SetKeyValue("limitview","0")
	ent:SetPos(pos)
	ent:SetAngles(angle)
	ent:SetNotSolid(true)
	ent:SetNoDraw(true)

	ent.HandleAnimation = HandleRollercoasterAnimation

	ent:Spawn()
	ent:Activate()
	ent:SetCollisionGroup(COLLISION_GROUP_WORLD) 

	local phys = ent:GetPhysicsObject()
	if IsValid(phys) then
		phys:EnableMotion(false)
	end

	return ent
end

hook.Add("KeyRelease", "EnterSeat", function(ply, key)
	if CLIENT then return end
	if key != IN_USE || ply:InVehicle() || (ply.ExitTime && CurTime() < ply.ExitTime + 1) then return end

	local eye = ply:EyePos()
	local trace = util.TraceLine({start=eye, endpos=eye+ply:GetAimVector()*100, filter=ply})

	if !IsValid(trace.Entity) then return end
	if trace.Entity:GetClass() != "coaster_cart" then return end //Don't mess with anyone else's shit

	//Store a list of occupants on the cart
	if !trace.Entity.Occupants then
		trace.Entity.Occupants = {}
	end
	table.insert( trace.Entity.Occupants, ply )

	local model = trace.Entity:GetModel()

	local offsets = ChairOffsets[string.lower(model)]
	if !offsets then return end

	local usetable = trace.Entity.UseTable or {}
	local pos = -1

	if #offsets > 1 then
		local localpos = trace.Entity:WorldToLocal(trace.HitPos)
		local bestpos, bestdist = -1

		for k,v in pairs(offsets) do
			local dist = localpos:Distance(v)
			if !usetable[k] && (bestpos == -1 || dist < bestdist) then
				bestpos, bestdist = k, dist
			end
		end

		if bestpos == -1 then return end
		pos = bestpos
	elseif !usetable[1] then
		pos = 1
	else
		return
	end

	usetable[pos] = true
	trace.Entity.UseTable = usetable


	ply.EntryPoint = ply:GetPos()
	ply.EntryAngles = ply:EyeAngles()
	ply.SeatEnt = trace.Entity
	ply.SeatPos = pos

	local ang = trace.Entity:GetAngles()
	if NotRight[model] then
		ang:RotateAroundAxis(trace.Entity:GetUp(), NotRight[model])
	else
		ang:RotateAroundAxis(trace.Entity:GetUp(), -90)
	end

	local s = CreateSeatAtPos(trace.Entity:LocalToWorld(offsets[pos]), ang)
	s:SetParent(trace.Entity)
	s:SetOwner(ply)

	ply:EnterVehicle(s)
end)

hook.Add("CanPlayerEnterVehicle", "EnterSeat", function(ply, vehicle)
	if vehicle:GetClass() != "prop_vehicle_prisoner_pod" then return end

	if vehicle.Removing then return false end
	if vehicle:GetOwner() == ply then return true end //Don't return false or else the player can't enter any other vehicle
end)

local airdist = Vector(0,0,48)

function TryPlayerExit(ply, ent)
	local pos = ent:GetPos()
	local trydist = 8
	local yawval = 0
	local yaw = Angle(0, ent:GetAngles().y, 0)

	while trydist <= 64 do
		local telepos = pos + yaw:Forward() * trydist
		local trace = util.TraceEntity({start=telepos, endpos=telepos - airdist}, ply)

		if !trace.StartSolid && trace.Fraction > 0 && trace.Hit then
			ply:SetPos(telepos)
			return
		end

		yaw:RotateAroundAxis(yaw:Up(), 15)
		yawval = yawval + 15
		if yawval > 360 then
			yawval = 0
			trydist = trydist + 8
		end
	end

	print("player", ply, "couldn't get out")
end

local function PlayerLeaveVehice( vehicle, ply )
	if vehicle:GetClass() != "prop_vehicle_prisoner_pod" then return end

	//Remove them from the list of occupants
	local parent = vehicle:GetParent()
	if IsValid( parent ) && parent:GetClass() == "coaster_cart" && parent.Occupants && #parent.Occupants > 0 then

		for k, v in pairs( parent.Occupants ) do
			if v == ply then table.remove( parent.Occupants, k ) end
			parent:PlayerLeave( ply )
		end
	end


	if !IsValid(ply.SeatEnt) then
		return true
	end

	if ply.SeatEnt.UseTable then
		ply.SeatEnt.UseTable[ply.SeatPos] = false
	end
	ply.SeatPos = 0
	ply.SeatEnt = nil

	ply.ExitTime = CurTime()
	ply:ExitVehicle()

	ply:SetEyeAngles(ply.EntryAngles)

	local trace = util.TraceEntity({start=ply.EntryPoint, endpos=ply.EntryPoint}, ply)

	if vehicle:GetPos():Distance(ply.EntryPoint) < 128 && !trace.StartSolid && trace.Fraction > 0 then
		ply:SetPos(ply.EntryPoint)
	else
		TryPlayerExit(ply, vehicle)
	end

	ply:SetCollisionGroup( COLLISION_GROUP_DEBRIS_TRIGGER )

	return false

end

hook.Add("CanExitVehicle", "Leave", PlayerLeaveVehice)

function PlayerExitLeft( ply )
	local Vehicle = ply:GetVehicle()
	
	if IsValid( Vehicle ) then
		PlayerLeaveVehice( Vehicle, ply )
	end
end

hook.Add("PlayerDeath", "VehicleKilled", PlayerExitLeft)
hook.Add("PlayerSilentDeath", "VehicleKilled", PlayerExitLeft)
hook.Add("PlayerDisconnected","VehicleCleanup", PlayerExitLeft)